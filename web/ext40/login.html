<!DOCTYPE html>
<html>
<title>Login Moca Test</title>
<head>
<meta charset="utf-8" />
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="expires" content="0">
	<script type="text/javascript" src="ext-debug.js"></script>
	<link href="resources/css/ext-all.css" rel="stylesheet" type="text/css" />
</head>

<body>
	<script type="text/javascript">
	var env = {};
		Ext.onReady(function(){
			//alert('aaaa');
			var loginForm= Ext.create('Ext.form.Panel',
			           {
			           	  title:'Login',
			           	  bodyPadding:5,
			           	  width:350,
			           	  shadow:true,
			           	  layout:'anchor',
			           	  defaults: {
			           	  	anchor: '100%'
			           	  },
			           	  defaultType: 'textfield',
			           	  fieldDefaults: {
			           	  	labelAlign:'left',
			           	  	labelWidth: 100
			           	  },
			           	  items:[
			           	    {
			           	    	  fieldLabel: 'User Name',
			           	    	  name: 'name',
			           	    	allowBlank: false
			           	    },
			           	    {
			           	    	  fieldLabel: 'User Password',
			           	    	  name: 'pswd',
			           	    	allowBlank: false
			           	    }
			           	   ],
			           	   buttons:[
			           	    {
			           	    	text:'Reset',
			           	    	handler:function()
			           	    	{
			           	    		this.up('form').getForm().reset();
			           	    	}
			           	    },
			           	    {
			           	    	text:'Submit',
			           	    	formBind:true,
			           	    	disabled:true,
			           	    	handler:function()
			           	    	{
                            //alert("aaaaabbb");
                            var form=this.up('form').getForm();
                            var user=this.up('form').down('[name=name]').value;
                            var password=this.up('form').down('[name=pswd]').value;
                            	 //form.standardSubmit=true;
                            if (form.isValid())
                            {
                            	   form.submit(
                            	   {
                            	   			url: 'http://localhost:4900/service',
			           	                    params:{Query: 'login user where usr_id ="' + user + '" and usr_pswd="' + password +'"',
			           	  	                ResponseFormat:'json'},
			           	                    method: 'POST',
			           	                    submitEmptyText:false,
                            	   	    //reader:Ext.data.reader.Xml,
                            	   	    success: function(form, action)
                            	   	    {
                            	   	    	   Ext.Msg.alert('Success');
                            	   	    },
                            	   	    failure: function(form, action)
                            	   	    {
                            	   	    	   switch(action.failureType)
                            	   	    	   {
                            	   	    	   	   case Ext.form.action.Action.CLIENT_INVALID:
                            	   	    	   	   	    //Ext.Msg.alert('Fail1:', Ext.form.action.Action.CLIENT_INVALID);
                            	   	    	   	   	    //break;
                            	   	    	   	   case Ext.form.action.Action.CONNECT_FAILURE:
                            	   	    	   	   	    //Ext.Msg.alert('Fail2:', Ext.form.action.Action.CONNECT_FAILURE);
                            	   	    	   	   	    //break;
                            	   	    	   	   case Ext.form.action.Action.SERVER_INVALID:
                            	   	    	   	   	    //Ext.Msg.alert('Fail3:', Ext.form.action.Action.SERVER_INVALID);
                            	   	    	   	   	    //break;
                            	   	    	   }
                            	   	    	   
                            	   	    	   var jsonv = eval("("+action.response.responseText+")");
                            	   	    	   //Ext.Msg.alert('User', jsonv.values[0][0]);
                            	   	    	   //Ext.Msg.alert('Session_key', jsonv.values[0][1]);
                            	   	    	   env ="USR_ID="+jsonv.values[0][0] + ":SESSION_KEY="+jsonv.values[0][1];
                            	   	    	   Ext.Msg.alert("Environment:", env);
                            	   	    	   loginForm.hide();
                            	   	    	   commandForm.show();
                            	   	    	   //Ext.Msg.alert('failed','bbbb');
                            	   	    },
                            	   	    callback:function(p1,p2,p3)
                            	   	    {
                            	   	    		Ext.Msg.alert('completed','ccc');
                            	   	    }
                            	   	});
                            }
			           	    	}
			           	    }
			           	   ],
			           	   renderTo: Ext.getBody()
			        });
			        loginForm.center();
			        
			    		var commandForm= Ext.create('Ext.form.Panel',
			        {
			         	  title:'Command:',
			         	  bodyPadding:5,
			         	  width:350,
			         	  shadow:true,
			         	  layout:'anchor',
			         	  defaultType: 'textarea',
			           	fieldDefaults: {
			           		labelAlign:'left',
			           		labelWidth: 100
			           	},
			           	items:[
			           	{
			           	  	  fieldLabel: 'Command to execute:',
			           	  	  name: 'command',
			           	  	allowBlank: false
			           	}
			           	],
			            buttons:[
			           	    {
			           	    	text:'Submit',
			           	    	formBind:true,
			           	    	disabled:true,
			           	    	handler:function()
			           	    	{
                            //alert("aaaaabbb");
                            var form=this.up('form').getForm();
                            var cmd=this.up('form').down('[name=command]').value;
                            	 //form.standardSubmit=true;
                            if (form.isValid())
                            {
                            	   form.submit(
                            	   {
                            	   			url: 'http://localhost:4900/service',
			           	                    params:{Query: cmd,
			           	                    	      Environment: env,
			           	  	                        ResponseFormat:'json'},
			           	                    method: 'POST',
			           	                    submitEmptyText:false,
                            	   	    //reader:Ext.data.reader.Xml,
                            	   	    success: function(form, action)
                            	   	    {
                            	   	    	   Ext.Msg.alert('Success');
                            	   	    },
                            	   	    failure: function(form, action)
                            	   	    {
                            	   	    	   switch(action.failureType)
                            	   	    	   {
                            	   	    	   	   case Ext.form.action.Action.CLIENT_INVALID:
                            	   	    	   	   	    //Ext.Msg.alert('Fail1:', Ext.form.action.Action.CLIENT_INVALID);
                            	   	    	   	   	    //break;
                            	   	    	   	   case Ext.form.action.Action.CONNECT_FAILURE:
                            	   	    	   	   	    //Ext.Msg.alert('Fail2:', Ext.form.action.Action.CONNECT_FAILURE);
                            	   	    	   	   	    //break;
                            	   	    	   	   case Ext.form.action.Action.SERVER_INVALID:
                            	   	    	   	   	    //Ext.Msg.alert('Fail3:', Ext.form.action.Action.SERVER_INVALID);
                            	   	    	   	   	    //break;
                            	   	    	   }
                            	   	    	   
                            	   	    	   var jsonv = eval("("+action.response.responseText+")");
                            	   	    	   //Ext.Msg.alert('User', jsonv.values[0][0]);
                            	   	    	   //Ext.Msg.alert('Session_key', jsonv.values[0][1]);
                            	   	    	   //Ext.Msg.alert("result:", jsonv);
                            	   	    	   for(var i=0; i<jsonv.values.length; i++)
                            	   	    	   {
                            	   	    	   	    var row;
                            	   	    	   	    for(var j=0; j<jsonv.values[i].length; j++)
                            	   	    	   	    {
                            	   	    	   	    	  if (row == undefined)
                            	   	    	   	    	  {
                            	   	    	   	    	      row= jsonv.values[i][j];
                            	   	    	   	    	  }
                            	   	    	   	    	  else
                            	   	    	   	    	  {
                            	   	    	   	    	  	  row += jsonv.values[i][j];
                            	   	    	   	    	  }
                            	   	    	   	    }
                            	   	    	   	    console.log('Row '+ i, row);
                            	   	    	   	    Ext.Msg.alert('Row '+i, row);
                            	   	    	   	}
                            	   	    	   //Ext.Msg.alert('failed','bbbb');
                            	   	    }
                            	   	});
                            }
			           	    	}
			           	    }
			           	   ],
			           	renderTo: Ext.getBody()
			        });
			        commandForm.center();
			        commandForm.hide();
      });
</script>
<div id='resulttext'></div>
</body>
</html>